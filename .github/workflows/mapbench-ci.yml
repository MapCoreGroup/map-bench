name: Map Bench CI/CD

on:
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Version Tag (e.g., 1.0.5)' # Static hint only
        required: true
        type: string

jobs:
  build-and-tag:
    runs-on: ubuntu-latest
    # Map the step output to the job output so 'deploy-app' can read it
    outputs:
      new_tag: ${{ steps.set_tag.outputs.final_tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # REPLACED: "Bump Version" script is gone.
      # ADDED: Logic to set the input as the tag, push it, and export it.
      - name: Create and Push Tag
        id: set_tag
        run: |
          INPUT_TAG="${{ inputs.tag_name }}"
          
          # 1. Create the tag locally
          git tag $INPUT_TAG
          
          # 2. Push the tag to the repo
          git push origin $INPUT_TAG
          
          # 3. Output the tag so the next steps and jobs can use it
          echo "final_tag=$INPUT_TAG" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to JFrog
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.CONTAINER_REGISTRY }}
          username: ${{ secrets.JFROG_USER }}
          password: ${{ secrets.JFROG_TOKEN }}

      - name: Build and Push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          # UPDATED: Uses the tag we just defined in the step above
          tags: |
            ${{ secrets.CONTAINER_REGISTRY }}/mapcore-docker/map-bench:${{ steps.set_tag.outputs.final_tag }}
            ${{ secrets.CONTAINER_REGISTRY }}/mapcore-docker/map-bench:latest
          
          secrets: |
            jfrog_token=${{ secrets.JFROG_TOKEN }}
            
          build-args: |
            VITE_MAPBOX_TOKEN=${{ secrets.VITE_MAPBOX_TOKEN }}
            VITE_GOOGLE_API_KEY=${{ secrets.VITE_GOOGLE_API_KEY }}
            VITE_CESIUM_TOKEN=${{ secrets.VITE_CESIUM_TOKEN }}
            VITE_MAPTILER_KEY=${{ secrets.VITE_MAPTILER_KEY }}
            VITE_MAPCORE_SERVER_URL=${{ secrets.VITE_MAPCORE_SERVER_URL }}
            VITE_GOOGLE_3D_TILES_URL=${{ secrets.VITE_GOOGLE_3D_TILES_URL }}
            VITE_WAYBACK_MAPTILES_WMTS_URL=${{ secrets.VITE_WAYBACK_MAPTILES_WMTS_URL }}
            VITE_WMTS_LAYERS_LIST=${{ secrets.VITE_WMTS_LAYERS_LIST }}
            VITE_WMTS_TILING_SCHEME=${{ secrets.VITE_WMTS_TILING_SCHEME }}

  deploy-app:
    needs: build-and-tag
    uses: ./.github/workflows/deploy-logic.yml
    with:
      environment_name: 'Production'
      # UPDATED: This now correctly grabs the manual input from the job above
      version_tag: ${{ needs.build-and-tag.outputs.new_tag }}
      container_app_name: 'map-bench-app'
    secrets:
      AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
      CONTAINER_REGISTRY: ${{ secrets.CONTAINER_REGISTRY }}
      AZURE_MC_RESOURCE_GROUP: ${{ secrets.AZURE_MC_RESOURCE_GROUP }}
      AZURE_SUBSCRIPTION_ID : ${{ secrets.AZURE_SUBSCRIPTION_ID }}
