name: Map Bench CI/CD

on:
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Version Tag (e.g., 1.0.5 or v1.0.5)' # Static hint only
        required: true
        type: string

jobs:
  build-and-tag:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    # Map the step output to the job output so 'deploy-app' can read it
    outputs:
      new_tag: ${{ steps.set_tag.outputs.final_tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # REPLACED: "Bump Version" script is gone.
      # ADDED: Logic to set the input as the tag, push it, and export it.
      - name: Create and Push Tag
        id: set_tag
        run: |
          # Ensure this workflow is only triggered from the default branch
          if [ "${{ github.ref }}" != "refs/heads/${{ github.event.repository.default_branch }}" ]; then
            echo "Error: This workflow can only be triggered from the default branch (${{ github.event.repository.default_branch }})." >&2
            echo "Current branch: ${{ github.ref }}" >&2
            exit 1
          fi

          INPUT_TAG="${{ inputs.tag_name }}"

          # Validate that the tag only contains safe characters for a Git tag
          # Allowed: letters, digits, dot, underscore, hyphen
          if ! printf '%s\n' "$INPUT_TAG" | grep -Eq '^[A-Za-z0-9._-]+$'; then
            echo "Error: Invalid tag name '$INPUT_TAG'. Allowed characters are: A-Z, a-z, 0-9, '.', '_', '-'." >&2
            exit 1
          fi
          
          # Check if the tag already exists locally
          if git rev-parse -q --verify "refs/tags/$INPUT_TAG" >/dev/null; then
            echo "Error: Tag '$INPUT_TAG' already exists locally. Please choose a different tag name." >&2
            exit 1
          fi
          
          # Check if the tag already exists on the remote
          if git ls-remote --tags origin "$INPUT_TAG" | grep -q "refs/tags/$INPUT_TAG$"; then
            echo "Error: Tag '$INPUT_TAG' already exists on the remote 'origin'. Please choose a different tag name." >&2
            exit 1
          fi
          
          # Configure Git user identity for tagging
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # 1. Create the tag locally as an annotated tag for better traceability
          git tag -a "$INPUT_TAG" -m "Release $INPUT_TAG"
          
          # 2. Push the tag to the repo
          if ! git push origin "$INPUT_TAG"; then
            echo "Warning: Initial push of tag '$INPUT_TAG' failed. Checking for possible concurrent creation..." >&2
            if git ls-remote --tags origin "$INPUT_TAG" | grep -q "refs/tags/$INPUT_TAG$"; then
              echo "Error: Tag '$INPUT_TAG' now exists on remote 'origin'. It was likely created concurrently by another process." >&2
            else
              echo "Error: Failed to push tag '$INPUT_TAG' to remote 'origin' for an unknown reason." >&2
            fi
            exit 1
          fi
          
          # 3. Output the tag so the next steps and jobs can use it
          echo "final_tag=$INPUT_TAG" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to JFrog
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.CONTAINER_REGISTRY }}
          username: ${{ secrets.JFROG_USER }}
          password: ${{ secrets.JFROG_TOKEN }}

      - name: Build and Push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          # UPDATED: Uses the tag we just defined in the step above
          tags: |
            ${{ secrets.CONTAINER_REGISTRY }}/mapcore-docker/map-bench:${{ steps.set_tag.outputs.final_tag }}
            ${{ secrets.CONTAINER_REGISTRY }}/mapcore-docker/map-bench:latest
          
          secrets: |
            jfrog_token=${{ secrets.JFROG_TOKEN }}
            
          build-args: |
            VITE_MAPBOX_TOKEN=${{ secrets.VITE_MAPBOX_TOKEN }}
            VITE_GOOGLE_API_KEY=${{ secrets.VITE_GOOGLE_API_KEY }}
            VITE_CESIUM_TOKEN=${{ secrets.VITE_CESIUM_TOKEN }}
            VITE_MAPTILER_KEY=${{ secrets.VITE_MAPTILER_KEY }}
            VITE_MAPCORE_SERVER_URL=${{ secrets.VITE_MAPCORE_SERVER_URL }}
            VITE_GOOGLE_3D_TILES_URL=${{ secrets.VITE_GOOGLE_3D_TILES_URL }}
            VITE_WAYBACK_MAPTILES_WMTS_URL=${{ secrets.VITE_WAYBACK_MAPTILES_WMTS_URL }}
            VITE_WMTS_LAYERS_LIST=${{ secrets.VITE_WMTS_LAYERS_LIST }}
            VITE_WMTS_TILING_SCHEME=${{ secrets.VITE_WMTS_TILING_SCHEME }}

  deploy-app:
    needs: build-and-tag
    uses: ./.github/workflows/deploy-logic.yml
    with:
      environment_name: 'Production'
      # UPDATED: This now correctly grabs the manual input from the job above
      version_tag: ${{ needs.build-and-tag.outputs.new_tag }}
      container_app_name: 'map-bench-app'
    secrets:
      AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
      CONTAINER_REGISTRY: ${{ secrets.CONTAINER_REGISTRY }}
      AZURE_MC_RESOURCE_GROUP: ${{ secrets.AZURE_MC_RESOURCE_GROUP }}
      AZURE_SUBSCRIPTION_ID : ${{ secrets.AZURE_SUBSCRIPTION_ID }}
